<!DOCTYPE html>
<html lang="de">
	<head>
		<title>Rollout Monitor</title>
		<style>
			:root {
				--font-big-size: 2rem;
				--font-medium-size: 1.5rem;
				--font-small-size: 1rem;
				--main-dark: #009879;
				--main-medium: #006a60;
				--main-light: #40b3a2;
				--accent-bright: #ffc10b;
				--accent-medium: #ffd23f;
				--accent-light: #ffe57a;
				--margin-big: 2rem;
				--margin-medium: 1rem;
				--magin-small: 0.5rem;
			}

			@font-face {
				font-family: "dashboardfont";
				src: url("fonts/Roboto-Regular.ttf");
			}

			* {
				font-family: "dashboardfont", sans-serif;
				animation: fadein 0.1s;
			}

			body {
				background-color: #f7f7f7;
			}

			/* Add the fade-in animation */
			@keyframes fadein {
				from {
					opacity: 0;
				}

				to {
					opacity: 1;
				}
			}

			@media only screen and (max-width: 1400px) {
				.dropdown {
					display: none;
				}

				#combined-dropdown {
					display: block !important;
				}

				#dropdown-selector {
					display: block !important;
				}

				nav .right {
					justify-content: right;
					margin-right: 10vw !important;
				}

				.dropdown-content {
					margin: 0;
				}
			}

			.kpi-div {
				display: grid;
				justify-content: space-between;
				align-items: center !important;
				grid-template-columns: 2fr 1fr 1fr;
			}

			#completed-r340 {
				font-size: 2.5rem;
				color: #4fb477;
			}

			#completed-r350 {
				font-size: 2.5rem;
			}

			.header {
				display: flex;
				flex-direction: row;
				justify-content: space-between;
				align-items: center !important;
				margin-top: var(--magin-small) !important;
			}

			.header h1 {
				margin: 0 !important;
			}

			.project-grid {
				display: grid;
				grid-template-columns: 1fr;
				grid-gap: 1rem;
			}

			.project-box {
				background-color: white;
				border-radius: 10px;
				box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
				margin: 1rem;
				border-radius: 0.5rem;
				overflow-wrap: break-word;
				background-clip: border-box;
				border-width: 0px;
				border-style: solid;
				border-color: rgb(217, 222, 227);
				transition: all 0.3s ease 0s;
			}

			.project-box .title {
				color: #566a7f;
				font-size: 2.5rem;
				font-weight: 500;
				margin: 0;
				margin-top: 1rem;
				text-align: center !important;
			}

			.kpis {
				display: grid;
				grid-template-columns: 1fr 1fr;
				text-align: center;
				margin: 0 !important;
				margin-top: 1.5rem !important;
				margin-left: 14rem !important;
				margin-right: 14rem !important;
			}

			.kpi-box {
				margin: 0 !important;
			}

			.kpi-box#outOfScope {
				margin-right: 0.5rem !important;
			}

			.kpi-box#completed {
				margin-left: 0.5rem !important;
				margin-right: 0.5rem !important;
			}

			.kpi-box#planned {
				margin-left: 0.5rem !important;
				margin-right: 0.5rem !important;
			}

			.kpi-box#unplanned {
				margin-left: 0.5rem !important;
			}

			#top {
				margin-left: 18rem !important;
				margin-right: 18rem !important;
				display: inline !important;
			}

			#top.kpi-value {
				font-size: 3.5rem !important;
				font-weight: 600;
				animation: fadein 1s;
			}

			#top-RotF {
				display: grid !important;
				grid-template-columns: 1fr 1fr;
			}

			#top-RotF.kpi-value {
				font-size: 3.5rem !important;
				font-weight: 600;
				animation: fadein 1s;
			}

			#chart-nso {
				margin-left: 0 !important;
				margin-right: 0 !important;
				grid-template-columns: 1fr 3fr 1fr 1fr;
			}

			#chart-nso .kpi-value {
				margin-bottom: 0 !important;
			}

			#chart-RotF {
				margin-left: 0 !important;
				margin-right: 0 !important;
			}

			#chart-RotF .kpi-value {
				margin-bottom: 0 !important;
			}

			.chart-container {
				margin: 0 !important;
			}

			.kpis .kpi-value {
				font-size: 3.5rem;
				font-weight: 600;
				animation: fadein 1s;
			}

			.kpis #total-nso {
				color: #6b9ac4;
				font-size: 4.5rem;
			}

			.kpis #outOfScope-value {
				color: #5196a7ea;
			}

			.kpis #total-RotF {
				color: #6b9ac4;
				font-size: 4.5rem;
			}

			.kpis #unplanned {
				color: #ba1b1d;
			}

			.kpis #unplanned-RotF {
				font-size: 4.5rem;
			}

			.kpis #completed {
				color: #3d8056;
			}

			.kpis #planned {
				color: #f7b32b;
			}

			.kpis .kpi-title {
				color: #566a7f;
				font-size: 1.2rem;
				font-weight: 500;
				margin: 0 !important;
				margin-top: 0.2rem;
			}

			hr {
				position: relative;
				height: 4px;
				border: none;
				border-radius: 10px;
				font-weight: bold;
			}

			.completed-divider {
				background-color: #4fb477;
			}

			.outOfScope-divider {
				background-color: #5196a7ea;
			}

			.planned-divider {
				background-color: #f7b32b;
			}

			.unplanned-divider {
				background-color: #ba1b1d;
			}

			@media (max-width: 1400px) {
				.project-grid {
					grid-template-columns: repeat(1, 1fr);
				}
			}

			@media (max-width: 1800px) {
				#top-RotF {
					margin-left: 9.5rem !important;
					margin-right: 9.5rem !important;
				}
			}
		</style>

		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta charset="utf-8" />
		<title>Rollout Monitor</title>
		<link
			rel="icon"
			href="../images/Logo SOS IS GmbH Neu shadow_tif.webp"
		/>
		<script src=" https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<script src="https://www.kryogenix.org/code/browser/sorttable/sorttable.js"></script>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
		/>
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
		/>
		<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0/dist/chartjs-plugin-datalabels.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
		<link rel="stylesheet" href="../styling/table.css" />
		<link rel="stylesheet" href="../styling/nav.css" />
		<link rel="stylesheet" href="../styling/search_and_refresh.css" />
		<link rel="stylesheet" href="../styling/header.css" />
		<link rel="stylesheet" href="../styling/info_box.css" />
		<link rel="stylesheet" href="../styling/background.css" />
		<link rel="stylesheet" href="../styling/div.css" />
		<link rel="stylesheet" href="../styling/popup.css" />
		<link rel="stylesheet" href="statustable.css" />
		<script src="../js-components/navbar.js"></script>
		<script src="/commons.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
	</head>

	<app-nav> </app-nav>
	<body
		onload="openForm([loadRestaurantKPIs, loadRestaurantChart, loadOutOfScope])"
	>
		<div class="form-popup" id="myForm">
			<form class="form-container">
				<h1>Login</h1>
				<label
					class="error-mark"
					for="psw"
					style="display: none; color: red; font-size: 15px"
					><b>Ung√ºltiges Passwort</b></label
				>
				<input
					type="password"
					placeholder="Enter Password"
					name="psw"
					required
				/>
				<button type="submit" class="btn">Login</button>
			</form>
		</div>

		<section id="home">
			<div class="header">
				<h1 id="bestellstatus">Bestellstatus: X / X</h1>
				<div class="refresh-search-container">
					<!-- Refresh button -->
					<button
						class="refresh-button"
						onclick="openForm([loadRestaurantKPIs, loadRestaurantChart, loadOutOfScope]);"
					>
						<i class="fa fa-refresh" style="margin-right: 10px"></i
						>Aktualisieren
					</button>
					<!-- Search box container -->
				</div>
			</div>
		</section>

		<div class="project-grid">
			<div class="project-box">
				<div class="box-line">
					<div class="title">
						Status Servermigration (R340-SSD/R350)
					</div>
				</div>
				<div class="kpis" id="top">
					<div class="kpi-box">
						<div class="kpi-value" id="total-nso">10</div>

						<div class="kpi-title">Target (Restaurants)</div>
					</div>
				</div>

				<div class="completed-planned-box">
					<div class="kpis" id="chart-nso">
						<div class="kpi-box" id="outOfScope">
							<div class="kpi-value" id="outOfScope-value">
								10
							</div>

							<hr class="outOfScope-divider" />

							<div class="kpi-title">Out of Scope</div>
						</div>
						<div class="kpi-box" id="completed">
							<div class="kpi-div">
								<div class="kpi-value" id="completed-nso">
									10
								</div>

								<div class="kpi-value" id="completed-r340">
									10
								</div>
								<div class="kpi-value" id="completed-r350">
									10
								</div>
							</div>

							<hr class="completed-divider" />
							<div class="kpi-div">
								<div class="kpi-title">Completed</div>

								<div class="kpi-title">R340-SSD</div>
								<div class="kpi-title">R350</div>
							</div>
						</div>

						<div class="kpi-box" id="planned">
							<div class="kpi-value" id="planned-nso">20</div>

							<hr class="planned-divider" />
							<div class="kpi-title">Planned</div>
						</div>

						<div class="kpi-box" id="unplanned">
							<div class="kpi-value" id="unplanned-nso">20</div>

							<hr class="unplanned-divider" />
							<div class="kpi-title">Unplanned</div>
						</div>
					</div>

					<div class="chart-container">
						<canvas
							id="NSO-chart"
							width="350"
							height="100"
						></canvas>
					</div>
				</div>
			</div>
		</div>

		<script>
			function loadRestaurantKPIs() {
				if (checkPassword()) {
					const password = window.selectedPassword;
					const wb_name = "servermigration_2023_r350_1";

					fetch(
						"https://europe-west3-shopysmart-600e7.cloudfunctions.net/get-rollout-data",
						{
							method: "POST",
							headers: {
								"Content-Type": "application/json",
							},
							body: JSON.stringify({
								password: password,
								wb_name: wb_name,
							}),
						}
					)
						.then((response) => {
							if (!response.ok) {
								throw new Error("Network response was not ok");
							}
							return response.json();
						})
						.then((data) => {
							const target = data[0][0];
							const plannedValue = data[0][1];
							const completedValue = data[0][2];
							const unplannedValue = data[0][3];
							const completedR340 = data[0][4];
							const completedR350 = data[0][5];
							const bestellt = data[0][6];
							const insgesamt = data[0][7];

							// get the element with class ="kpi-value" and id = "planned"
							const planned = document.querySelector(
								".kpi-value#planned-nso"
							);
							// set the innerHTML of the element to the value of the planned_value variable
							planned.innerHTML = plannedValue;

							// get the element with class ="kpi-value" and id = "planned"
							const bestellstatus =
								document.querySelector("#bestellstatus");
							const newText =
								"Bestellstatus: " +
								bestellt +
								" / " +
								insgesamt;
							bestellstatus.textContent = newText;

							// get the element with class ="kpi-value" and id = "planned"
							const R340 = document.querySelector(
								".kpi-value#completed-r340"
							);
							// set the innerHTML of the element to the value of the planned_value variable
							R340.innerHTML = completedR340;

							// get the element with class ="kpi-value" and id = "planned"
							const r350 = document.querySelector(
								".kpi-value#completed-r350"
							);
							// set the innerHTML of the element to the value of the planned_value variable
							r350.innerHTML = completedR350;

							// get the element with class ="kpi-value" and id = "completed"
							const completed = document.querySelector(
								".kpi-value#completed-nso"
							);
							// set the innerHTML of the element to the value of the completed_value variable
							completed.innerHTML = completedValue;

							// get the element with class ="kpi-value" and id = "completed"
							const unplanned = document.querySelector(
								".kpi-value#unplanned-nso"
							);
							// set the innerHTML of the element to the value of the completed_value variable
							unplanned.innerHTML = unplannedValue;

							// get the element with class ="kpi-value" and id = "total"
							const total = document.querySelector(
								".kpi-value#total-nso"
							);
							// set the innerHTML of the element to the value of the target_value variable
							total.innerHTML = target;
						})
						.catch((error) => {
							console.error(
								"There was a problem with the fetch operation:",
								error
							);
						});
				}
			}
		</script>

		<script>
			function loadOutOfScope() {
				if (checkPassword()) {
					const password = window.selectedPassword;
					const wb_name = "servermigration_2023_r350_2";

					fetch(
						"https://europe-west3-shopysmart-600e7.cloudfunctions.net/get-rollout-data",
						{
							method: "POST",
							headers: {
								"Content-Type": "application/json",
							},
							body: JSON.stringify({
								password: password,
								wb_name: wb_name,
							}),
						}
					)
						.then((response) => {
							if (!response.ok) {
								throw new Error("Network response was not ok");
							}
							return response.json();
						})
						.then((data) => {
							const outOfScope = data[0][0];

							const outofscope = document.querySelector(
								".kpi-value#outOfScope-value"
							);
							outofscope.innerHTML = outOfScope;
						})
						.catch((error) => {
							console.error(
								"There was a problem with the fetch operation:",
								error
							);
						});
				}
			}
		</script>

		<script>
			function loadRestaurantChart() {
				if (checkPassword()) {
					const password = window.selectedPassword;
					const wb_name = "servermigration_2023_r350_3";

					//Get number of month of todays date
					var today = new Date();
					var month = today.getMonth();

					fetch(
						"https://europe-west3-shopysmart-600e7.cloudfunctions.net/get-rollout-data",
						{
							method: "POST",
							headers: {
								"Content-Type": "application/json",
							},
							body: JSON.stringify({
								password: password,
								wb_name: wb_name,
							}),
						}
					)
						.then((response) => {
							if (!response.ok) {
								throw new Error("Network response was not ok");
							}
							return response.json();
						})
						.then((data) => {
							const week_labels = data[0];
							// Check for data[2] and assign to completedData
							var completedData = data[2] ? data[2] : [];

							// Check for data[3] and assign to plannedData
							var plannedData = data[3] ? data[3] : [];

							// Check for data[4] and assign to unplannedData
							var unplannedData = data[4] ? data[4] : [];

							const ctx = document
								.getElementById("NSO-chart")
								.getContext("2d");

							var completed_min = [];
							var planned_min = [];
							var unplanned_min = [];

							function round_up(old_list, new_list) {
								// Multiply each value by 5 and store it in the new list
								for (var i = 0; i < old_list.length; i++) {
									var new_list_value = 0;
									if (old_list[i] == 0) {
										new_list_value = 0;
									} else if (old_list[i] > 50) {
										new_list_value = old_list[i];
									} else if (old_list[i] <= 50) {
										new_list_value = 50;
									}
									new_list.push(new_list_value);
								}
								return new_list;
							}

							completed_min = round_up(
								completedData,
								completed_min
							);
							planned_min = round_up(plannedData, planned_min);
							unplanned_min = round_up(
								unplannedData,
								unplanned_min
							);

							const options = {
								legend: {
									display: false,
								},
								scales: {
									xAxes: [
										{
											stacked: true,
											ticks: {
												display: true,
											},
											gridLines: {
												display: false,
											},
										},
									],
									yAxes: [
										{
											stacked: true,
											ticks: {
												display: false,
											},
											gridLines: {
												display: true,
												color: "rgba(0, 0, 0, 0)",
												zeroLineColor:
													"rgba(0, 0, 0, 1)",
												drawBorder: false,
												drawTicks: false,
											},
										},
									],
								},
								plugins: {
									tooltip: {
										enabled: false,
									},
									customText: {
										color: "black",
										font: {
											size: 14,
											weight: "bold",
											family: "Arial",
										},
										position: {
											x: 0,
											y: 0,
										},
										text: "",
									},
									datalabels: {
										formatter: function (value, context) {
											// Display nso[index] as the label on the bars for the "nso_min" dataset
											if (
												context.dataset.label ===
												"Completed"
											) {
												return completedData[
													context.dataIndex
												];
											}
											if (
												context.dataset.label ===
												"Planned"
											) {
												return plannedData[
													context.dataIndex
												];
											}
											if (
												context.dataset.label ===
												"Unplanned"
											) {
												return unplannedData[
													context.dataIndex
												];
											}
											return value;
										},

										anchor: "end",
										align: "start",
										color: "white",
										font: {
											size: 19,
											weight: "bold",
											family: "Arial",
										},
									},
								},
								layout: {
									padding: {
										top: 30,
										bottom: 20,
									},
								},
							};

							const myChart = new Chart(ctx, {
								type: "bar",
								data: {
									labels: week_labels,
									datasets: [
										{
											label: "Completed",
											backgroundColor: function (
												context
											) {
												return context.dataIndex === 0
													? "rgba(79, 180, 119, 1)"
													: completedColor;
											},
											data: completed_min,
											borderWidth: 1,
										},
										{
											label: "Planned",
											data: planned_min,
											backgroundColor: plannedColor,
											borderWidth: 1,
										},
										{
											label: "Unplanned",
											data: unplanned_min,
											backgroundColor: unplannedColor,
											borderWidth: 1,
										},
									],
								},
								options: options,
							});
						})
						.catch((error) => {
							console.error(
								"There was a problem with the fetch operation:",
								error
							);
						});
				}
			}
		</script>
	</body>
</html>
